# Configuration CI/CD pour GEVA-Sco Voice Assistant V3
# Forge Edu - GitLab CI avec d√©ploiement Docker

stages:
  - install
  - test
  - build
  - publish
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Nom de l'image pour le Container Registry
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE/gevasco-voice

# Cache pour acc√©l√©rer les builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - node_modules/

# Installation des d√©pendances
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - echo "Installation des d√©pendances du backend..."
    - cd backend
    - npm install --prefer-offline --no-audit
  artifacts:
    paths:
      - backend/node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# V√©rification de la configuration
verify_setup:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "V√©rification de la structure du projet..."
    - ls -la
    - test -f "backend/server.js" || (echo "‚ùå backend/server.js manquant" && exit 1)
    - test -f "backend/package.json" || (echo "‚ùå backend/package.json manquant" && exit 1)
    - test -f "index.html" || (echo "‚ùå index.html manquant" && exit 1)
    - test -f "Dockerfile" || (echo "‚ùå Dockerfile manquant" && exit 1)
    - echo "‚úÖ Structure du projet valid√©e"
  only:
    - main
    - develop
    - merge_requests

# V√©rification de la syntaxe JavaScript
lint_check:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "V√©rification de la syntaxe JavaScript..."
    - cd backend
    - node -c server.js
    - echo "‚úÖ Syntaxe JavaScript valid√©e"
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Build et publication de l'image Docker vers le Container Registry
build_and_push_docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
    - echo "üîê Connexion au Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "üê≥ Construction de l'image Docker GEVA-Sco Voice V3..."
    - docker build -t $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker build -t $DOCKER_IMAGE:latest .
    - echo "üì§ Publication vers le Container Registry..."
    - docker push $DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_IMAGE:latest
    - echo "‚úÖ Image Docker publi√©e avec succ√®s"
    - echo "üì¶ Image: $DOCKER_IMAGE:latest"
  only:
    - main
    - develop

# Build de validation (sans Docker)
build_project:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "Build du projet GEVA-Sco Voice V3..."
    - echo "Version $(node --version)"
    - echo "NPM version $(npm --version)"
    - cd backend
    - npm list
    - echo "‚úÖ Build termin√© avec succ√®s"
  artifacts:
    paths:
      - backend/
      - index.html
      - js/
      - css/
      - Dockerfile
      - docker-compose.yml
      - start.sh
      - .env.example
    expire_in: 1 week
  only:
    - main
    - develop

# Notification de succ√®s avec instructions de d√©ploiement
deploy_instructions:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üéâ Pipeline ex√©cut√© avec succ√®s!"
    - echo "‚úÖ GEVA-Sco Voice Assistant V3 - Build OK"
    - echo "üì¶ Version 3.0.0"
    - echo ""
    - echo "=========================================="
    - echo "üê≥ INSTRUCTIONS DE D√âPLOIEMENT"
    - echo "=========================================="
    - echo ""
    - echo "L'image Docker est disponible dans le Container Registry:"
    - echo "  $DOCKER_IMAGE:latest"
    - echo ""
    - echo "Pour ex√©cuter l'application sur un serveur:"
    - echo ""
    - echo "1. Se connecter au Registry:"
    - echo "   docker login $CI_REGISTRY"
    - echo ""
    - echo "2. T√©l√©charger l'image:"
    - echo "   docker pull $DOCKER_IMAGE:latest"
    - echo ""
    - echo "3. Lancer le conteneur:"
    - echo "   docker run -d -p 3000:3000 \\"
    - echo "     -e OPENAI_API_KEY=votre_cl√© \\"
    - echo "     --name gevasco-voice \\"
    - echo "     $DOCKER_IMAGE:latest"
    - echo ""
    - echo "4. Acc√©der √† l'application:"
    - echo "   http://localhost:3000"
    - echo ""
    - echo "=========================================="
  when: on_success
  only:
    - main
    - develop
