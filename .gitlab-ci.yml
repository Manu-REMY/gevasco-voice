# Configuration CI/CD pour GEVA-Sco Voice Assistant V3
# Forge Edu - GitLab CI

stages:
  - install
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Cache pour acc√©l√©rer les builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - node_modules/

# Installation des d√©pendances
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - echo "Installation des d√©pendances du backend..."
    - cd backend
    - npm install --prefer-offline --no-audit
  artifacts:
    paths:
      - backend/node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# V√©rification de la configuration
verify_setup:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "V√©rification de la structure du projet..."
    - ls -la
    - test -f "backend/server.js" || (echo "‚ùå backend/server.js manquant" && exit 1)
    - test -f "backend/package.json" || (echo "‚ùå backend/package.json manquant" && exit 1)
    - test -f "index.html" || (echo "‚ùå index.html manquant" && exit 1)
    - echo "‚úÖ Structure du projet valid√©e"
  only:
    - main
    - develop
    - merge_requests

# V√©rification de la syntaxe JavaScript
lint_check:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "V√©rification de la syntaxe JavaScript..."
    - cd backend
    - node -c server.js
    - echo "‚úÖ Syntaxe JavaScript valid√©e"
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Build Docker Image (optionnel - n√©cessite Docker-in-Docker)
build_docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - echo "üê≥ Construction de l'image Docker GEVA-Sco Voice V3..."
    - docker build -t gevasco-voice:${CI_COMMIT_SHORT_SHA} .
    - docker build -t gevasco-voice:latest .
    - echo "‚úÖ Image Docker construite avec succ√®s"
    - docker images | grep gevasco-voice
  allow_failure: true
  only:
    - main
    - develop

# Build (optionnel, pour validation)
build_project:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "Build du projet GEVA-Sco Voice V3..."
    - echo "Version $(node --version)"
    - echo "NPM version $(npm --version)"
    - cd backend
    - npm list
    - echo "‚úÖ Build termin√© avec succ√®s"
  artifacts:
    paths:
      - backend/
      - index.html
      - js/
      - css/
      - Dockerfile
      - docker-compose.yml
      - start.sh
      - .env.example
    expire_in: 1 week
  only:
    - main
    - develop

# Pages GitLab d√©sactiv√© - L'application n√©cessite un backend Node.js
# Pour d√©ployer : utilisez Docker (voir DEPLOIEMENT-FORGE.md)
# pages:
#   stage: deploy
#   ...

# Notification de succ√®s
success_notification:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üéâ Pipeline ex√©cut√© avec succ√®s!"
    - echo "‚úÖ GEVA-Sco Voice Assistant V3 - Build OK"
    - echo "üì¶ Version 3.0.0"
  when: on_success
  only:
    - main
    - develop
