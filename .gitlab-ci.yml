# Configuration CI/CD pour GEVA-Sco Voice Assistant V3
# Forge Edu - GitLab CI

stages:
  - install
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Cache pour accÃ©lÃ©rer les builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - backend/node_modules/
    - node_modules/

# Installation des dÃ©pendances
install_dependencies:
  stage: install
  image: node:${NODE_VERSION}
  script:
    - echo "Installation des dÃ©pendances du backend..."
    - cd backend
    - npm install --prefer-offline --no-audit
  artifacts:
    paths:
      - backend/node_modules/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# VÃ©rification de la configuration
verify_setup:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "VÃ©rification de la structure du projet..."
    - ls -la
    - test -f "backend/server.js" || (echo "âŒ backend/server.js manquant" && exit 1)
    - test -f "backend/package.json" || (echo "âŒ backend/package.json manquant" && exit 1)
    - test -f "index.html" || (echo "âŒ index.html manquant" && exit 1)
    - echo "âœ… Structure du projet validÃ©e"
  only:
    - main
    - develop
    - merge_requests

# VÃ©rification de la syntaxe JavaScript
lint_check:
  stage: test
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "VÃ©rification de la syntaxe JavaScript..."
    - cd backend
    - node -c server.js
    - echo "âœ… Syntaxe JavaScript validÃ©e"
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Build Docker Image (optionnel - nÃ©cessite Docker-in-Docker)
build_docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - echo "ğŸ³ Construction de l'image Docker GEVA-Sco Voice V3..."
    - docker build -t gevasco-voice:${CI_COMMIT_SHORT_SHA} .
    - docker build -t gevasco-voice:latest .
    - echo "âœ… Image Docker construite avec succÃ¨s"
    - docker images | grep gevasco-voice
  allow_failure: true
  only:
    - main
    - develop

# Build (optionnel, pour validation)
build_project:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - install_dependencies
  script:
    - echo "Build du projet GEVA-Sco Voice V3..."
    - echo "Version $(node --version)"
    - echo "NPM version $(npm --version)"
    - cd backend
    - npm list
    - echo "âœ… Build terminÃ© avec succÃ¨s"
  artifacts:
    paths:
      - backend/
      - index.html
      - js/
      - css/
      - Dockerfile
      - docker-compose.yml
      - start.sh
      - .env.example
    expire_in: 1 week
  only:
    - main
    - develop

# Pages GitLab (dÃ©ploiement statique)
pages:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - build_project
  script:
    - echo "PrÃ©paration du dÃ©ploiement GitLab Pages..."
    - mkdir -p public
    - cp -r *.html public/ 2>/dev/null || true
    - cp -r js public/ 2>/dev/null || true
    - cp -r css public/ 2>/dev/null || true
    - cp -r *.md public/ 2>/dev/null || true
    - echo "âœ… DÃ©ploiement prÃ©parÃ©"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main

# Notification de succÃ¨s
success_notification:
  stage: deploy
  image: alpine:latest
  script:
    - echo "ğŸ‰ Pipeline exÃ©cutÃ© avec succÃ¨s!"
    - echo "âœ… GEVA-Sco Voice Assistant V3 - Build OK"
    - echo "ğŸ“¦ Version 3.0.0"
  when: on_success
  only:
    - main
    - develop
